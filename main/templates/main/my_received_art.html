{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}My Received Art{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/pages/my_received.css' %}">
{% endblock %}

{% block content %}

<h1 class="page-title container-narrow">My Received Art</h1>
<br>

{% if request.user.is_authenticated and request.user.receive_art_paused %}
<div class='container-narrow'>
  <div class="alert alert-warning d-flex align-items-center justify-content-between" role="alert">
    <div>
      <strong>New art delivery is paused.</strong>
      You won’t receive new pieces while paused. Go to
      <a class="alert-link fw-bold text-decoration-underline" href="{% url 'account_info_settings' %}?section=art-delivery#art-delivery">
        Settings → Art Delivery
      </a>
      to resume.
    </div>
  </div>
</div>
{% endif %}

<div class="container-narrow">
  {# use the same spacing system as My Shared #}
  <div class="shared-list">
    {% for received in received_pieces %}
      {% with piece=received.art_piece %}
      <section id="art-{{ piece.public_id }}" class="received-card">
        <!-- Header: title/artist + prominent sharer -->
        <header class="received-card__header">
          <div class="received-card__titlewrap">
            <a class="received-card__title" href="{% url 'art_detail' piece.public_id %}">
              <strong>{{ piece.piece_name }}</strong>
            </a>
            <span class="received-card__by">({{ piece.artist_name }})</span>
          </div>

          <div class="received-card__from">
            Shared by
            <strong>{{ piece.user.first_name }} {{ piece.user.last_name }}</strong>
          </div>

          {% if not received.seen_at %}
            <span class="badge-new" title="New">New</span>
          {% endif %}
        </header>

        <!-- Body: description + prominent Source CTA -->
        <div class="received-card__body">
          <p class="received-card__description">{{ piece.piece_description|linebreaksbr }}</p>

          {% if piece.link %}
            <a class="btn btn-outline-success btn-sm received-card__source"
               href="{{ piece.link }}" target="_blank" rel="noopener"
               aria-label="Open source for {{ piece.piece_name }}">
              View source
              <i class="fa-solid fa-up-right-from-square me-1" aria-hidden="true"></i>
            </a>
          {% endif %}
        </div>

        <!-- Like button (no inline names here) -->
        <div class="likes-container" id="heart-{{ piece.id }}-container">
          {% include 'main/heart_button.html' with piece=piece %}
        </div>

        <!-- Conversation preview strip (no count; open/start CTAs) -->
        {% with pv=previews|dict_get:piece.id %}
          <div class="preview">
            {% if pv.unread_count and pv.unread_count|add:0 > 0 %}
              <div class="preview__left">
                <span class="badge preview__badge" aria-label="{{ pv.unread_count }} new messages">
                  {{ pv.unread_count }} new message{% if pv.unread_count != 1 %}s{% endif %}
                </span>
              </div>
              <div class="preview__right">
                <a href="{% url 'art_detail' piece.public_id %}"
                  class="btn btn-cta btn-cta--amber btn-sm"
                  aria-label="View conversation for {{ piece.piece_name }}">
                  <i class="fa-regular fa-comments me-1" aria-hidden="true"></i>
                  View conversation
                </a>
              </div>

            {% elif pv.thread_exists %}
              <div class="preview__left">
                <span class="preview__label">Last message</span>
                {% with m=pv.last %}
                  <span class="preview__text">
                    <strong>{{ m.sender.first_name }} {{ m.sender.last_name }}</strong> — {{ m.text|truncatechars:120 }}
                  </span>
                {% endwith %}
              </div>
              <div class="preview__right">
                <a href="{% url 'art_detail' piece.public_id %}"
                  class="btn btn-cta btn-cta--amber btn-sm"
                  aria-label="View conversation for {{ piece.piece_name }}">
                  <i class="fa-regular fa-comments me-1" aria-hidden="true"></i>
                  View conversation
                </a>
              </div>

            {% else %}
              <div class="preview__left">
                <span class="preview__hint">No messages yet — say hi to {{ piece.user.first_name }}!</span>
              </div>
              <div class="preview__right">
                <a href="{% url 'art_detail' piece.public_id %}#reply"
                  class="btn btn-cta btn-sm"
                  aria-label="Start a conversation about {{ piece.piece_name }}">
                  <i class="fa-regular fa-paper-plane me-1" aria-hidden="true"></i>
                  Start a conversation
                </a>
              </div>
            {% endif %}
          </div>
        {% endwith %}
      </section>
      {% endwith %}
    {% empty %}
      <p>You haven't received anything yet — make sure to
        <a href="/share-art">share something</a> so you don't miss out!</p>
    {% endfor %}
  </div>
</div>

{% endblock %}