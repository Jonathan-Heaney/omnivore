{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}My Received Art{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/pages/my_received.css' %}">
{% endblock %}

{% block content %}

<div class="container-narrow py-4">

<!-- Welcome hero -->
<div class="welcome-hero">
  <div class="welcome-bubble" aria-hidden="true">
    <strong>Welcome!</strong>
    This is your home for discovering new art. Everything you’ve received lives below.
    Come back every Friday for a new piece!
  </div>

  <div class="welcome-oliver-wrap">
    <picture>
      <source
        type="image/avif"
        srcset="
          {% static 'images/oliver-no-bg-240.avif' %} 240w,
          {% static 'images/oliver-no-bg-360.avif' %} 360w,
          {% static 'images/oliver-no-bg-480.avif' %} 480w,
          {% static 'images/oliver-no-bg-720.avif' %} 720w
        "
        sizes="(max-width: 576px) 44vw, (max-width: 992px) 32vw, 360px"
      />
      <source
        type="image/webp"
        srcset="
          {% static 'images/oliver-no-bg-240.webp' %} 240w,
          {% static 'images/oliver-no-bg-360.webp' %} 360w,
          {% static 'images/oliver-no-bg-480.webp' %} 480w,
          {% static 'images/oliver-no-bg-720.webp' %} 720w
        "
        sizes="(max-width: 576px) 44vw, (max-width: 992px) 32vw, 360px"
      />
      <img
        class="welcome-oliver"
        src="{% static 'images/oliver-no-bg-360.png' %}"
        alt="Oliver the Omnivore mascot"
        width="360" height="360"
        loading="eager" decoding="async" fetchpriority="high"
      />
    </picture>
    <div class="welcome-caption">Oliver the Omnivore</div>
  </div>
</div>

<h1 class="page-title">Gallery</h1>

{% if request.user.is_authenticated and request.user.receive_art_paused %}
<div class='container-narrow'>
  <div class="alert alert-warning d-flex align-items-center justify-content-between" role="alert">
    <div>
      <strong>New art delivery is paused.</strong>
      You won’t receive new pieces while paused. Go to
      <a class="alert-link fw-bold text-decoration-underline" href="{% url 'account_info_settings' %}?section=art-delivery#art-delivery">
        Settings → Art Delivery
      </a>
      to resume.
    </div>
  </div>
</div>
{% endif %}


  {# use the same spacing system as My Shared #}
  <div class="shared-list">
    {% for received in received_pieces %}
      {% with piece=received.art_piece %}
          <section id="art-{{ piece.public_id }}" class="received-card {% if piece.is_deleted %}received-card--deleted{% endif %}">
        <!-- Header -->
        <header class="received-card__header">
          <div class="received-card__titlewrap">
            {% if piece.is_deleted %}
              <span class="received-deleted-title">
                <strong>[Deleted piece]</strong>
              </span>
            {% else %}
              <a class="received-card__title" href="{% url 'art_detail' piece.public_id %}?focus=piece">
                <strong>{{ piece.piece_name }}</strong>
              </a>
              <span class="received-card__by">({{ piece.artist_name }})</span>
            {% endif %}
          </div>

          <div class="received-card__from">
            Shared by <strong>{{ piece.user.first_name }} {{ piece.user.last_name }}</strong>
          </div>

          {% if received.is_new %}
            <span class="badge-new" title="New">New</span>
          {% endif %}
        </header>

        <!-- Body -->
        <div class="received-card__body">
          {% if piece.is_deleted %}
            <div class="tombstone">
              <p class="mb-2"><em>This piece was deleted by the original sharer.</em></p>
              {% with pv=previews|dict_get:piece.id %}
                {% if pv.thread_exists %}
                  <p class="text-muted mb-0">Your conversation is still available below.</p>
                {% endif %}
              {% endwith %}
            </div>
          {% else %}
            <p class="received-card__description">{{ piece.piece_description|linebreaksbr }}</p>

            {% if piece.link %}
              <a class="btn btn-outline-success btn-sm received-card__source"
                href="{{ piece.link }}" target="_blank" rel="noopener"
                aria-label="Open source for {{ piece.piece_name }}">
                View source
                <i class="fa-solid fa-up-right-from-square me-1" aria-hidden="true"></i>
              </a>
            {% endif %}
          {% endif %}
        </div>

        <!-- Like button (hidden for deleted) -->
        {% if not piece.is_deleted %}
          <div class="likes-container" id="heart-{{ piece.id }}-container">
            {% include 'main/heart_button.html' with piece=piece %}
          </div>
        {% endif %}

        <!-- Conversation preview strip -->
        {% with pv=previews|dict_get:piece.id %}
          <div class="preview {% if piece.is_deleted %}preview--deleted{% endif %}">
            {% if piece.is_deleted %}
              {% if pv.thread_exists %}
                {% if pv.unread_count and pv.unread_count|add:0 > 0 %}
                  <div class="preview__left">
                    <span class="preview__badge" aria-label="{{ pv.unread_count }} new messages">
                      {{ pv.unread_count }} new message{% if pv.unread_count != 1 %}s{% endif %}
                    </span>
                  </div>
                {% else %}
                  <div class="preview__left">
                    <span class="preview__label">Last message</span>
                    {% with m=pv.last %}
                      <span class="preview__text">
                        <strong>{{ m.sender.first_name }} {{ m.sender.last_name }}</strong> — {{ m.text|truncatechars:120 }}
                      </span>
                    {% endwith %}
                  </div>
                {% endif %}

                <div class="preview__right">
                  <a href="{% url 'art_detail' piece.public_id %}?focus=thread"
                    class="btn btn-cta btn-cta--amber btn-sm"
                    aria-label="View conversation for {{ piece.piece_name }}">
                    <i class="fa-regular fa-comments me-1" aria-hidden="true"></i>
                    View conversation
                  </a>
                </div>
              {% else %}
                {# Deleted + no conversation → no button, just a hint #}
                <div class="preview__left">
                  <span class="preview__hint text-muted">No conversation.</span>
                </div>
              {% endif %}
            {% else %}
              {# Normal (not deleted) behavior #}
              {% if pv.unread_count and pv.unread_count|add:0 > 0 %}
                <div class="preview__left">
                  <span class="preview__badge" aria-label="{{ pv.unread_count }} new messages">
                    {{ pv.unread_count }} new message{% if pv.unread_count != 1 %}s{% endif %}
                  </span>
                </div>
                <div class="preview__right">
                  <a href="{% url 'art_detail' piece.public_id %}?focus=thread"
                    class="btn btn-cta btn-cta--amber btn-sm"
                    aria-label="View conversation for {{ piece.piece_name }}">
                    <i class="fa-regular fa-comments me-1" aria-hidden="true"></i>
                    View conversation
                  </a>
                </div>

              {% elif pv.thread_exists %}
                <div class="preview__left">
                  <span class="preview__label">Last message</span>
                  {% with m=pv.last %}
                    <span class="preview__text">
                      <strong>{{ m.sender.first_name }} {{ m.sender.last_name }}</strong> — {{ m.text|truncatechars:120 }}
                    </span>
                  {% endwith %}
                </div>
                <div class="preview__right">
                  <a href="{% url 'art_detail' piece.public_id %}?focus=thread"
                    class="btn btn-cta btn-cta--amber btn-sm"
                    aria-label="View conversation for {{ piece.piece_name }}">
                    <i class="fa-regular fa-comments me-1" aria-hidden="true"></i>
                    View conversation
                  </a>
                </div>

              {% else %}
                <div class="preview__left">
                  <span class="preview__hint">No messages yet — say hi to {{ piece.user.first_name }}!</span>
                </div>
                <div class="preview__right">
                  <a href="{% url 'art_detail' piece.public_id %}"
                    class="btn btn-cta btn-sm"
                    aria-label="Start a conversation about {{ piece.piece_name }}">
                    <i class="fa-regular fa-paper-plane me-1" aria-hidden="true"></i>
                    Start a conversation
                  </a>
                </div>
              {% endif %}
            {% endif %}
          </div>
        {% endwith %}
      </section>
      {% endwith %}
    {% empty %}
      <p>You haven't received anything yet — make sure to
        <a href="/share-art">share something</a> so you don't miss out!</p>
    {% endfor %}
  </div>
</div>

{% endblock %}