{% extends 'base.html' %}
{% load static %}

{% block title %} Account Settings {% endblock %}
{% block css_files %}
  <link rel="stylesheet" href="{% static "css/styles.css" %}">
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
  <h1 class="header">Account Settings</h1>

<!-- Account Info -->
<div id="account-info">
  <h2>Account Information</h2>
  <form method="post" id="account-info-form" action="{% url 'account_info_settings' %}">
  {% csrf_token %}
  {{ account_form|crispy }}

  <div id="account-info-message-container">
    {% if messages %}
      <ul class="messages">
      {% for message in messages %}
        {% if 'account' in message.tags %}
          <li class="alert alert-success">{{ message }}</li>
        {% endif %}
      {% endfor %}
      </ul>
    {% endif %}
  </div>

  <button type="submit" class="btn btn-primary" id="save-account-info" disabled>Save Account Info</button>
</form>

</div>

<hr>

<!-- Email Preferences -->
<!-- Email Preferences -->
<div id="email-prefs">
  <h2>Email Notification Preferences</h2>
  <form method="post" id="email-pref-form" action="{% url 'email_pref_settings' %}#email-prefs">
    {% csrf_token %}
    {{ email_form|crispy }}

    <div id="email-message-container"></div>

    <button type="submit" class="btn btn-primary" id="save-email-prefs" disabled>Save Email Preferences</button>
  </form>
</div>
<hr>

<!-- Password Change -->
<div id="password">
  <h2>Change Password</h2>
  <form method="post" id="password-form" action="{% url 'password_settings' %}#password">
    {% csrf_token %}
    {{ password_form|crispy }}

    <div id="password-message-container"></div>

    <button type="submit" class="btn btn-primary" id="save-password" disabled>Change Password</button>
  </form>
</div>

</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // === ACCOUNT INFO FORM ===
  const accountForm = document.getElementById("account-info-form");
  const accountInputs = accountForm.querySelectorAll("input");
  const accountButton = document.getElementById("save-account-info");
  const messageContainer = document.getElementById("account-info-message-container");

  const originalAccountValues = Array.from(accountInputs).map(input => input.value);

  function hasChanges() {
    return Array.from(accountInputs).some((input, i) => input.value !== originalAccountValues[i]);
  }

  function resetButtonAndMessage() {
    accountButton.disabled = true;
    const ul = document.createElement("ul");
    ul.classList.add("messages");
    const li = document.createElement("li");
    li.classList.add("alert", "alert-success");
    li.textContent = "Account information updated.";
    ul.appendChild(li);
    messageContainer.innerHTML = "";
    messageContainer.appendChild(ul);
  }

    accountForm.addEventListener("input", () => {
    const changed = hasChanges();
    accountButton.disabled = !changed;
    if (changed) {
      messageContainer.innerHTML = ""; // Remove message only when making a real change
    }
  });

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(accountForm);
    accountButton.disabled = true;

    const response = await fetch(accountForm.action, {
      method: "POST",
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData,
    });

    if (response.ok) {
      const data = await response.json();
      resetButtonAndMessage();
      // Update baseline values so next edit cycle works
      for (let i = 0; i < accountInputs.length; i++) {
        originalAccountValues[i] = accountInputs[i].value;
      }
    } else {
      accountButton.disabled = false;
      alert("Something went wrong. Please try again.");
    }
  });

});

// === EMAIL PREFERENCES FORM ===
const emailForm = document.getElementById("email-pref-form");
const emailInputs = emailForm.querySelectorAll("input[type=checkbox]");
const emailButton = document.getElementById("save-email-prefs");
const emailMessageContainer = document.getElementById("email-message-container");

// Store original state
const originalEmailValues = Array.from(emailInputs).map(cb => cb.checked);

// Utility to check for changes
function emailFormHasChanges() {
  return Array.from(emailInputs).some((cb, i) => cb.checked !== originalEmailValues[i]);
}

// Enable/disable button based on form state
emailForm.addEventListener("change", () => {
  const changed = emailFormHasChanges();
  emailButton.disabled = !changed;
  if (changed) {
    emailMessageContainer.innerHTML = ""; // Clear old message
  }
});

// Handle submit via Fetch
emailForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(emailForm);
  const response = await fetch(emailForm.action, {
    method: "POST",
    headers: {
      "X-Requested-With": "XMLHttpRequest",
    },
    body: formData,
  });

  if (response.ok) {
    const data = await response.json();
    emailMessageContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
    emailButton.disabled = true;

    // Update the original values to match the now-saved state
    emailInputs.forEach((cb, i) => {
      originalEmailValues[i] = cb.checked;
    });
  } else {
    emailMessageContainer.innerHTML = `<div class="alert alert-danger">There was a problem saving your preferences.</div>`;
  }
});

// === PASSWORD FORM ===
const passwordForm = document.getElementById("password-form");
const oldPassword = passwordForm.querySelector("input[name=old_password]");
const newPassword1 = passwordForm.querySelector("input[name=new_password1]");
const newPassword2 = passwordForm.querySelector("input[name=new_password2]");
const passwordButton = document.getElementById("save-password");
const passwordMessageContainer = document.getElementById("password-message-container");

// Helper: Check if form is filled and passwords match
function validatePasswordForm() {
  const oldFilled = oldPassword.value.trim() !== "";
  const new1Filled = newPassword1.value.trim() !== "";
  const new2Filled = newPassword2.value.trim() !== "";
  const passwordsMatch = newPassword1.value === newPassword2.value;
  return oldFilled && new1Filled && new2Filled && passwordsMatch;
}

// Helper: Reset form after success
function resetPasswordForm() {
  oldPassword.value = "";
  newPassword1.value = "";
  newPassword2.value = "";
  passwordButton.disabled = true;
}

// Update button state and clear messages on input
passwordForm.addEventListener("input", () => {
  const isValid = validatePasswordForm();
  passwordButton.disabled = !isValid;

  if (isValid) {
    passwordMessageContainer.innerHTML = "";
  }
});

// Handle submit via Fetch
passwordForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(passwordForm);

  try {
    const response = await fetch(passwordForm.action, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
      body: formData,
    });

    if (response.ok) {
      const data = await response.json();
      passwordMessageContainer.innerHTML = `
        <div class="alert alert-success">${data.message}</div>
      `;
      resetPasswordForm();
    } else {
      const errorData = await response.json();
      const errors = JSON.parse(errorData.errors);

      const errorList = Object.values(errors)
        .flatMap(fieldErrors =>
          fieldErrors.map(err => `<li class="alert alert-danger">${err.message}</li>`)
        )
        .join("");

      passwordMessageContainer.innerHTML = `<ul class="messages">${errorList}</ul>`;
    }
  } catch (err) {
    console.error("Unexpected error during password change:", err);
    passwordMessageContainer.innerHTML = `
      <div class="alert alert-danger">Something went wrong. Please try again.</div>
    `;
  }
});
</script>
{% endblock %}