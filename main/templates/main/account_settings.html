{% extends 'base.html' %}
{% load static %}

{% block title %} Account Settings {% endblock %}
{% block css_files %}
  <link rel="stylesheet" href="{% static "css/styles.css" %}">
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
  <h1 class="header">Account Settings</h1>

<!-- Account Info -->
<div id="account-info">
  <h2>Account Information</h2>
  <form method="post" id="account-info-form" action="{% url 'account_info_settings' %}#account-info">
    {% csrf_token %}
    {{ account_form|crispy }}

    {% if messages %}
        <ul class="messages">
        {% for message in messages %}
            {% if 'account' in message.tags %}
                <li class="alert alert-success">{{ message }}</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="save-account-info" disabled>Save Account Info</button>
  </form>

</div>

<hr>

<!-- Email Preferences -->
<div id="email-prefs">
  <h2>Email Notification Preferences</h2>
  <form method="post" id="email-pref-form" action="{% url 'email_pref_settings' %}#email-prefs">
    {% csrf_token %}
    {{ email_form|crispy }}

    {% if messages %}
        <ul class="messages">
        {% for message in messages %}
            {% if 'email' in message.tags %}
                <li class="alert alert-success">{{ message }}</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="save-email-prefs" disabled>Save Email Preferences</button>
  </form>
</div>

<hr>

<!-- Password Change -->
<div id="password">
  <h2>Change Password</h2>
  <form method="post" id="password-form" action="{% url 'password_settings' %}#password">
    {% csrf_token %}
    {{ password_form|crispy }}

    {% if messages %}
        <ul class="messages">
        {% for message in messages %}
            {% if 'password' in message.tags %}
                <li class="alert alert-success">{{ message }}</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="save-password" disabled>Change Password</button>
  </form>
</div>

</div>
{% endblock %}


{% block scripts %}
    <script>
document.addEventListener("DOMContentLoaded", () => {
  // === ACCOUNT INFO FORM ===
  const accountForm = document.getElementById("account-info-form");
  const accountInputs = accountForm.querySelectorAll("input");
  const accountButton = document.getElementById("save-account-info");

  const originalAccountValues = Array.from(accountInputs).map(input => input.value);
  accountForm.addEventListener("input", () => {
    const changed = Array.from(accountInputs).some((input, i) => input.value !== originalAccountValues[i]);
    accountButton.disabled = !changed;
  });

  // === EMAIL PREFERENCES FORM ===
  const emailForm = document.getElementById("email-pref-form");
  const emailInputs = emailForm.querySelectorAll("input[type=checkbox]");
  const emailButton = document.getElementById("save-email-prefs");

  const originalEmailValues = Array.from(emailInputs).map(cb => cb.checked);
  emailForm.addEventListener("change", () => {
    const changed = Array.from(emailInputs).some((cb, i) => cb.checked !== originalEmailValues[i]);
    emailButton.disabled = !changed;
  });

  // === PASSWORD FORM ===
  const passwordForm = document.getElementById("password-form");
  const oldPassword = passwordForm.querySelector("input[name=old_password]");
  const newPassword1 = passwordForm.querySelector("input[name=new_password1]");
  const newPassword2 = passwordForm.querySelector("input[name=new_password2]");
  const passwordButton = document.getElementById("save-password");

  function validatePasswordForm() {
    const allFilled = oldPassword.value && newPassword1.value && newPassword2.value;
    const passwordsMatch = newPassword1.value === newPassword2.value;
    passwordButton.disabled = !(allFilled && passwordsMatch);
  }

  passwordForm.addEventListener("input", validatePasswordForm);
});
</script>
{% endblock %}