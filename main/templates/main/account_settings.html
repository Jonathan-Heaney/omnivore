{% extends 'base.html' %}
{% load static %}

{% block title %} Account Settings {% endblock %}
{% block css_files %}
  <link rel="stylesheet" href="{% static "css/styles.css" %}">
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
  <h1 class="header">Account Settings</h1>

<!-- Account Info -->
<div id="account-info">
  <h2>Account Information</h2>
  <form method="post" id="account-info-form" action="{% url 'account_info_settings' %}">
  {% csrf_token %}
  {{ account_form|crispy }}

  <div id="account-info-message-container">
    {% if messages %}
      <ul class="messages">
      {% for message in messages %}
        {% if 'account' in message.tags %}
          <li class="alert alert-success">{{ message }}</li>
        {% endif %}
      {% endfor %}
      </ul>
    {% endif %}
  </div>

  <button type="submit" class="btn btn-primary" id="save-account-info" disabled>Save Account Info</button>
</form>

</div>

<hr>

<!-- Email Preferences -->
<div id="email-prefs">
  <h2>Email Notification Preferences</h2>
  <form method="post" id="email-pref-form" action="{% url 'email_pref_settings' %}#email-prefs">
    {% csrf_token %}
    {{ email_form|crispy }}

    {% if messages %}
        <ul class="messages">
        {% for message in messages %}
            {% if 'email' in message.tags %}
                <li class="alert alert-success">{{ message }}</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="save-email-prefs" disabled>Save Email Preferences</button>
  </form>
</div>

<hr>

<!-- Password Change -->
<div id="password">
  <h2>Change Password</h2>
  <form method="post" id="password-form" action="{% url 'password_settings' %}#password">
    {% csrf_token %}
    {{ password_form|crispy }}

    {% if messages %}
        <ul class="messages">
        {% for message in messages %}
            {% if 'password' in message.tags %}
                <li class="alert alert-success">{{ message }}</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="save-password" disabled>Change Password</button>
  </form>
</div>

</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // === ACCOUNT INFO FORM ===
  const accountForm = document.getElementById("account-info-form");
  const accountInputs = accountForm.querySelectorAll("input");
  const accountButton = document.getElementById("save-account-info");
  const messageContainer = document.getElementById("account-info-message-container");

  const originalAccountValues = Array.from(accountInputs).map(input => input.value);

  function hasChanges() {
    return Array.from(accountInputs).some((input, i) => input.value !== originalAccountValues[i]);
  }

  function resetButtonAndMessage() {
    accountButton.disabled = true;
    const ul = document.createElement("ul");
    ul.classList.add("messages");
    const li = document.createElement("li");
    li.classList.add("alert", "alert-success");
    li.textContent = "Account information updated.";
    ul.appendChild(li);
    messageContainer.innerHTML = "";
    messageContainer.appendChild(ul);
  }

    accountForm.addEventListener("input", () => {
    const changed = hasChanges();
    accountButton.disabled = !changed;
    if (changed) {
      messageContainer.innerHTML = ""; // Remove message only when making a real change
    }
  });

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(accountForm);
    accountButton.disabled = true;

    const response = await fetch(accountForm.action, {
      method: "POST",
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData,
    });

    if (response.ok) {
      const data = await response.json();
      resetButtonAndMessage();
      // Update baseline values so next edit cycle works
      for (let i = 0; i < accountInputs.length; i++) {
        originalAccountValues[i] = accountInputs[i].value;
      }
    } else {
      accountButton.disabled = false;
      alert("Something went wrong. Please try again.");
    }
  });

});
</script>
{% endblock %}