{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}My Shared{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/pages/my_shared.css' %}">
{% endblock %}

{% block content %}

<div class="container-narrow py-4">
  <h1 class="page-title">My Shared</h1>

  <div class="shared-list">
  {% for piece in pieces %}
    <section id="art-{{ piece.public_id }}" class="shared-card">
      <header class="shared-card__header">
        <a class="shared-card__title" href="{% url 'art_detail' piece.public_id %}">
          <strong>{{ piece.piece_name }}</strong>
        </a>
        <span class="shared-card__by">({{ piece.artist_name }})</span>
      </header>

      <div class="shared-card__body">
        <p class="shared-card__description">{{ piece.piece_description|linebreaksbr }}</p>
      </div>

      <footer class="shared-card__meta">
        <span class="shared-card__date">Shared {{ piece.created_at|date:"F j, Y" }}</span>

        <div class="shared-card__actions">
          <!-- Edit -->
          <a href="{% url 'edit_art_piece' piece.public_id %}"
             class="btn btn-outline-secondary btn-sm"
             aria-label="Edit {{ piece.piece_name }}"
             title="Edit">
            <i class="fa-solid fa-pen"></i>
          </a>

          <!-- Delete -->
          <form class="js-delete-form d-inline"
              action="{% url 'delete_art_piece' piece.public_id %}"
              method="post">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="button"
                  class="btn btn-outline-danger btn-sm js-open-delete"
                  data-delete-url="{% url 'delete_art_piece' piece.public_id %}"
                  data-delete-title="{{ piece.piece_name|escape }}">
            <i class="fa-solid fa-trash"></i>
          </button>
        </form>

          {% if piece.link %}
            <a class="btn btn-outline-primary btn-sm"
               href="{{ piece.link }}"
               target="_blank"
               rel="noopener"
               aria-label="Open source link for {{ piece.piece_name }}"
               title="Open source">
              <i class="fa-solid fa-up-right-from-square"></i>
            </a>
          {% endif %}
        </div>
      </footer>

      {% with users=likes_dict|dict_get:piece %}
        {% if users %}
          <div class="likes">
            {% include 'main/likes_display.html' with piece=piece likes_dict=likes_dict %}
          </div>
        {% endif %}
      {% endwith %}

      {% with s=summaries|dict_get:piece.id %}
        {% if s.conv_count and s.conv_count|add:0 > 0 %}
          <div class="summary">
            <div class="summary__left">
              <div class="summary__line">
                <span class="summary__label">Conversations</span>
                <span class="summary__value">{{ s.conv_count }}</span>

                <span class="summary__badges">
                  {% if s.new_conv_count and s.new_conv_count|add:0 > 0 %}
                    <span class="badge badge--newconv"
                          aria-label="{{ s.new_conv_count }} new conversation{% if s.new_conv_count != 1 %}s{% endif %}">
                      {{ s.new_conv_count }} new conversation{% if s.new_conv_count != 1 %}s{% endif %}
                    </span>
                  {% endif %}

                  {% if s.new_msg_count and s.new_msg_count|add:0 > 0 %}
                    <span class="badge badge--newmsg"
                          aria-label="{{ s.new_msg_count }} new message{% if s.new_msg_count != 1 %}s{% endif %}">
                      {{ s.new_msg_count }} new message{% if s.new_msg_count != 1 %}s{% endif %}
                    </span>
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="summary__right">
              <a href="{% url 'art_detail' piece.public_id %}"
                class="btn btn-cta btn-cta--amber btn-sm"
                aria-label="View conversations for {{ piece.piece_name }}">
                <i class="fa-regular fa-comments me-1"></i>
                View conversations
              </a>
            </div>
          </div>
        {% endif %}
      {% endwith %}
    </section>
  {% empty %}
    <p>Nothing shared yet â€” share something <a href="/share-art">here</a>!</p>
  {% endfor %}
  </div>
</div>

{% endblock %}